# TorrentClient

BitTorrent клиент для Windows, написанный на C# с использованием .NET 9.0 и Windows Forms.

## 🚀 Возможности

- ✅ **Полная поддержка протокола BitTorrent**
  - HTTP/HTTPS трекеры
  - UDP трекеры
  - TCP трекеры
  - DHT (Distributed Hash Table)
  - Peer Exchange (PEX)
  - Local Service Discovery

- ✅ **Управление загрузками**
  - Множественные одновременные загрузки
  - Приоритизация файлов
  - Автоматическое возобновление загрузок
  - Сохранение состояния торрентов

- ✅ **Контроль скорости**
  - Глобальные лимиты скорости загрузки/отдачи (общие для всех торрентов)
  - Индивидуальные лимиты для каждого торрента (в Mbps)
  - Алгоритм Token Bucket для точного контроля скорости
  - Визуальные индикаторы (⚡) для торрентов с активными лимитами
  - Отображение текущей скорости и установленных лимитов в интерфейсе
  - Точные расчёты скорости с использованием десятичной системы (1 Mbps = 1,000,000 бит/с)

- ✅ **Пользовательский интерфейс**
  - Современный Windows Forms интерфейс
  - Системный трей с уведомлениями
  - Отображение прогресса и статистики в реальном времени
  - Визуальные индикаторы для торрентов с ограничениями скорости
  - Отображение текущей скорости и лимитов в колонке "Скорость"
  - Подробные подсказки (tooltips) с информацией о лимитах
  - Управление торрентами (добавление, удаление, пауза)
  - Настройка глобальных и индивидуальных лимитов через удобные формы

- ✅ **Дополнительные функции**
  - Поддержка cookies и headers для трекеров
  - Логирование операций
  - Автоматическое сохранение состояния
  - Потокобезопасная архитектура

## 📋 Требования

- **.NET 9.0 SDK** или выше
- **Windows 10/11** (x64)
- **Visual Studio 2022** или **Visual Studio Code** (для разработки)

## 🛠️ Сборка

### Клонирование репозитория

```bash
git clone https://github.com/yourusername/TorrentClient.git
cd TorrentClient
```

### Сборка проекта

```bash
dotnet build
```

### Запуск тестов

```bash
dotnet test
```

### Публикация

```bash
dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true
```

## 📦 Структура проекта

```
TorrentClient/
├── Core/                    # Основная бизнес-логика
│   ├── TorrentManager.cs   # Менеджер торрентов
│   ├── TorrentDownloader.cs # Загрузчик торрентов
│   ├── AppSettingsManager.cs # Менеджер настроек приложения
│   ├── GlobalSpeedLimiter.cs # Глобальный ограничитель скорости
│   └── SpeedLimiter.cs     # Ограничитель скорости для торрента
├── Engine/                  # Движок BitTorrent
│   ├── TorrentClient.cs    # Главный клиент
│   ├── Swarm.cs            # Управление пирами
│   ├── Wire.cs             # Протокол обмена данными
│   └── Storage.cs          # Управление файлами
├── Protocol/                # Протоколы и сеть
│   ├── TrackerClient.cs    # Клиент трекеров
│   ├── PeerConnection.cs   # Соединения с пирами
│   ├── DhtNode.cs          # DHT узел
│   └── PiecePicker.cs      # Выбор кусков
├── UI/                      # Пользовательский интерфейс
│   ├── MainForm.cs         # Главная форма
│   ├── TorrentListViewUpdater.cs # Обновление списка торрентов
│   └── Services/           # UI сервисы
├── GlobalSettingsForm.cs   # Форма глобальных настроек
├── SpeedSettingsForm.cs    # Форма настроек скорости торрента
├── Utilities/               # Утилиты
│   ├── Bencode.cs          # Парсинг Bencode
│   └── Logger.cs           # Логирование
└── TorrentClient.Tests/     # Тесты
    ├── BencodeParserTests.cs
    ├── SpeedLimiterTests.cs
    └── ...
```

## 🧪 Тестирование

Проект включает комплексный набор unit-тестов с использованием xUnit:

- **BencodeParserTests** - тесты парсера Bencode
- **SpeedLimiterTests** - тесты ограничителя скорости для торрента
- **SpeedLimiterEdgeCasesTests** - тесты граничных случаев ограничителя скорости
- **SpeedLimiterUpdateLimitTests** - тесты обновления лимитов скорости
- **GlobalSpeedLimiterTests** - тесты глобального ограничителя скорости
- **SpeedConversionTests** - тесты конвертации единиц скорости
- **SpeedCalculationTests** - тесты расчёта скорости загрузки/отдачи
- **UpdateThrottlerTests** - тесты троттлинга обновлений UI
- **PiecePickerTests** - тесты выбора кусков
- **AppSettingsManagerTests** - тесты менеджера настроек (включая сохранение лимитов)
- **TaskTimeoutHelperTests** - тесты утилит таймаутов
- **UploadStatisticsTests** - тесты статистики отдачи

Запуск всех тестов:

```bash
dotnet test --verbosity normal
```

## 🏗️ Архитектура

Проект следует принципам SOLID и использует:

- **SRP (Single Responsibility Principle)** - каждый класс имеет одну ответственность
- **DIP (Dependency Inversion Principle)** - зависимость от абстракций через интерфейсы
- **Асинхронное программирование** - использование async/await для неблокирующих операций
- **Потокобезопасность** - использование `Lock`, `SemaphoreSlim` и других примитивов синхронизации
- **Управление памятью** - предотвращение утечек памяти через правильное использование `IDisposable`

### Система ограничения скорости

Проект использует двухуровневую систему ограничения скорости:

1. **GlobalSpeedLimiter** (Singleton) - глобальный ограничитель, применяется ко всем торрентам
2. **SpeedLimiter** - индивидуальный ограничитель для каждого торрента

Оба используют алгоритм **Token Bucket** для точного контроля скорости:
- Токены накапливаются с заданной скоростью
- Операции потребляют токены перед передачей данных
- При недостатке токенов операции ожидают их накопления

### Расчёт скорости

Все расчёты скорости используют **десятичную систему**:
- 1 Mbps = 1,000,000 бит/секунду (не 1,048,576)
- 1 Kbps = 1,000 бит/секунду
- Конвертация: `bytes/second * 8.0 / 1_000_000.0 = Mbps`

Это обеспечивает соответствие стандартным единицам измерения скорости интернет-соединений.

## 📝 Использование

1. Запустите приложение
2. Добавьте `.torrent` файл через меню или перетаскиванием
3. Выберите путь для загрузки
4. Настройте лимиты скорости:
   - **Глобальные лимиты**: Кнопка "Глобальные настройки" → установите общие лимиты для всех торрентов
   - **Лимиты для торрента**: Правый клик на торренте → "Настройки скорости" → установите индивидуальные лимиты
5. Отслеживайте прогресс в главном окне:
   - Торренты с активными лимитами отмечены иконкой ⚡
   - В колонке "Скорость" отображается текущая скорость и установленные лимиты
   - Наведите курсор на торрент для подробной информации о лимитах

## ⚙️ Настройки

Приложение сохраняет настройки в `appsettings.json`:

- **Путь загрузки по умолчанию** - автоматически сохраняется
- **Глобальные лимиты скорости** - лимиты загрузки и отдачи (в байтах/сек), применяются ко всем торрентам
- **Индивидуальные лимиты торрентов** - сохраняются для каждого торрента отдельно (в Mbps)
- **Cookies и headers для трекеров** - настройки для аутентификации на трекерах
- **Максимальное количество соединений** - ограничение количества одновременных соединений
- **Включение/выключение логирования** - управление уровнем детализации логов

### Формат лимитов скорости

- **Глобальные лимиты**: Сохраняются в байтах в секунду (bytes/second)
- **Лимиты торрентов**: Устанавливаются и отображаются в Mbps (мегабитах в секунду)
- **Конвертация**: Используется десятичная система (1 Mbps = 1,000,000 бит/с = 125,000 байт/с)

Все настройки автоматически сохраняются при изменении и загружаются при запуске приложения.

## 🔧 Разработка

### Добавление новых функций

1. Создайте интерфейс в соответствующей папке `Interfaces/`
2. Реализуйте интерфейс в соответствующем модуле
3. Добавьте unit-тесты
4. Обновите документацию при необходимости

### Стиль кода

- Используйте `async/await` для асинхронных операций
- Следуйте соглашениям именования C#
- Добавляйте XML-комментарии для публичных API
- Используйте `using` для управления ресурсами